# 한국어 단어 테트리스 - 기술 아키텍처

## 프로젝트 구조

```
wordtris/
├── lib/
│   ├── main.dart                # 앱 진입점
│   ├── app.dart                 # 앱 설정 및 테마
│   ├── routes.dart              # 라우팅 설정
│   ├── constants/               # 상수 값
│   ├── models/                  # 데이터 모델
│   │   ├── block.dart           # 블록 모델
│   │   ├── game_state.dart      # 게임 상태 모델
│   │   ├── word.dart            # 단어 모델
│   │   └── player.dart          # 플레이어 모델
│   ├── screens/                 # 화면 UI
│   │   ├── home_screen.dart     # 홈 화면
│   │   ├── game_screen.dart     # 게임 화면
│   │   ├── settings_screen.dart # 설정 화면
│   │   ├── leaderboard_screen.dart # 랭킹 화면
│   │   └── word_book_screen.dart # 단어장 화면
│   ├── widgets/                 # 재사용 위젯
│   │   ├── block_widget.dart    # 블록 위젯
│   │   ├── block_rotation.dart  # 블록 회전 위젯
│   │   ├── block_preview.dart   # 블록 미리보기 위젯
│   │   ├── game_grid.dart       # 게임 그리드
│   │   ├── score_board.dart     # 점수판
│   │   └── custom_button.dart   # 커스텀 버튼
│   ├── services/                # 서비스 로직
│   │   ├── game_service.dart    # 게임 로직 서비스
│   │   ├── word_service.dart    # 단어 검증 서비스
│   │   ├── storage_service.dart # 데이터 저장 서비스
│   │   ├── block_generator.dart # 블록 생성 서비스
│   │   ├── block_rotation.dart  # 블록 회전 서비스
│   │   └── audio_service.dart   # 오디오 서비스
│   ├── providers/               # 상태 관리
│   │   ├── game_provider.dart   # 게임 상태 관리
│   │   ├── settings_provider.dart # 설정 상태 관리
│   │   └── player_provider.dart # 플레이어 상태 관리
│   ├── utils/                   # 유틸리티 함수
│   │   ├── word_utils.dart      # 단어 관련 유틸리티
│   │   ├── rotation_utils.dart  # 블록 회전 유틸리티
│   │   └── game_utils.dart      # 게임 관련 유틸리티
│   └── database/                # 데이터베이스 관련
│       ├── database_helper.dart # DB 헬퍼 클래스
│       ├── word_repository.dart # 단어 저장소
│       └── player_repository.dart # 플레이어 데이터 저장소
├── assets/                      # 리소스
│   ├── fonts/                   # 폰트
│   ├── images/                  # 이미지
│   ├── audio/                   # 오디오
│   └── data/                    # 데이터 파일
│       └── korean_words.json    # 한국어 단어 데이터 (초기 세트)
├── test/                        # 테스트 코드
└── pubspec.yaml                 # 의존성 관리
```

## 기술 스택

### 프레임워크 및 언어
- **Flutter**: 크로스 플랫폼 UI 프레임워크
- **Dart**: 프로그래밍 언어

### 상태 관리
- **Provider**: 간단한 상태 관리를 위한 패키지
- **Flutter Bloc**: 복잡한 상태 관리가 필요한 경우 사용

### 데이터 저장
- **SharedPreferences**: 간단한 설정 데이터 저장
- **SQLite** (sqflite): 단어 데이터베이스 및 게임 기록 저장
- **Hive**: 경량 NoSQL 데이터베이스로 빠른 단어 검색을 위해 사용 가능

### 사용 라이브러리
- **flame**: 2D 게임 엔진, 게임 루프 및 렌더링 최적화
- **audioplayers**: 게임 효과음 및 배경음악
- **flutter_tts**: 단어 발음 지원 (교육용)
- **http**: 온라인 기능을 위한 네트워크 요청
- **google_fonts**: 다양한 폰트 지원
- **flutter_localizations**: 다국어 지원
- **sqlite_fts5**: 전체 텍스트 검색 확장 (대규모 단어 DB 검색용)
- **drift**: SQLite 기반 타입 안전 ORM (대규모 DB 관리)
- **flutter_bloc**: 상태 관리 라이브러리

## 아키텍처 설계

### 아키텍처 패턴
- **MVVM(Model-View-ViewModel)** 패턴 활용
  - Model: 데이터 모델 및 비즈니스 로직
  - View: Flutter 위젯으로 구성된 UI
  - ViewModel: Provider를 통한 상태 및 비즈니스 로직 관리

### 게임 엔진 설계
1. **게임 구조**
   - `GameProvider`를 통한 중앙 게임 상태 관리
   - 블록, 그리드, 단어 인식 모듈 간의 분리된 책임
   - 이벤트 기반 아키텍처로 게임 상태 변화에 반응

2. **블록 시스템**
   - 다양한 크기의 블록(1칸, 2칸, 3칸, 4칸) 지원
   - 각 블록은 여러 한글 글자를 포함 가능
   - 블록 생성기(BlockGenerator)를 통한 지능적 블록 생성
   - 단어 생성 확률 높이는 글자 조합 알고리즘
   - 블록 크기별 등장 확률 관리 (1칸: 5%, 2칸: 15%, 3칸: 40%, 4칸: 40%)

3. **블록 회전 시스템**
   - 블록 유형별 회전 패턴 지원 (1칸, 2칸, 3칸, 4칸)
   - `BlockRotationService`를 통한 회전 로직 캡슐화
   - 블록 형태에 따른 시계/반시계 방향 회전 처리
   - 회전된 블록의 배치 유효성 실시간 검증
   - 블록 회전 애니메이션 및 피드백 이펙트
   - 4칸 가로/세로 블록(horizontal4/vertical4)의 회전 패턴 최적화

4. **드래그 앤 드롭 상호작용**
   - 제스처 인식 시스템 (`GestureDetector` 활용)
   - 블록 선택, 회전 및 배치를 위한 통합 제스처 처리
   - 드래그 시작/진행/종료 이벤트 처리
   - 배치 가능 영역 실시간 하이라이트 기능
   - 블록 배치 유효성 확인 시스템

5. **그리드 관리**
   - 10x10 기본 그리드 크기 (커스터마이징 가능)
   - `GridCell` 클래스로 각 셀의 상태 관리
   - 효율적인 2D 배열 구현과 빠른 접근 최적화
   - 단어 완성 시 제거 로직 (중력 적용 없음)

6. **단어 검증 시스템**
   - 50만 라인 한국어 단어 데이터베이스 효율적 관리
   - SQLite FTS(Full Text Search) 확장 활용
   - 인메모리 캐싱으로 자주 사용되는 단어 빠른 검색
   - 가로/세로 방향 단어 검색 알고리즘
   - 트라이(Trie) 자료구조를 활용한 고속 검색

### 단어 데이터베이스 설계

1. **데이터 구조**
   - 효율적인 DB 스키마 설계 (단어, 길이, 난이도, 카테고리)
   - 인덱싱을 통한 빠른 검색 지원
   - 분할된 테이블로 단어 길이별/난이도별 관리

2. **데이터 처리 파이프라인**
   - 초기 데이터 세트는 앱에 내장 (~10,000 단어)
   - 백그라운드 작업자를 통한 대규모 DB 점진적 구축
   - 파일 분할 및 비동기 로딩으로 메모리 효율성 보장
   - 단어 빈도 분석 및 자주 사용되는 단어 우선 로드

3. **검색 최적화**
   - 블룸 필터를 활용한 빠른 후보 단어 필터링
   - 캐시 계층 구조로 메모리 사용 최적화
   - 비동기 검색 작업으로 UI 블로킹 방지
   - 단어 길이별 샤딩으로 검색 범위 축소

### UI 설계 및 렌더링
1. **게임 화면 구성**
   - 메인 그리드 영역 (블록 배치 공간)
   - 현재 선택 가능 블록 영역 (3개 표시)
   - 다음 블록 미리보기 영역 (2개 표시)
   - 블록 회전 컨트롤 (터치/클릭 또는 전용 버튼)
   - 점수 및 레벨 표시 영역
   - 완성한 단어 목록 표시 영역

2. **미리보기 시스템**
   - `BlockPreviewWidget`을 통한 다음 블록 미리보기 구현
   - 애니메이션 효과로 새 블록 등장 강조
   - 현재 선택 가능 블록과 다음 블록 간의 전환 애니메이션
   - 블록 회전 상태의 미리보기 반영

3. **블록 회전 UI**
   - 선택된 블록 주변에 회전 버튼 표시 (선택적)
   - 회전 방향 표시를 위한 시각적 가이드
   - 회전 애니메이션 및 회전 완료 피드백
   - 회전 불가능한 블록에 대한 상태 피드백

4. **렌더링 최적화**
   - `CustomPainter`를 활용한 고성능 그리드 렌더링
   - 캔버스 레이어링으로 부분 업데이트 지원
   - 애니메이션 프레임 제한을 통한 배터리 사용 최적화
   - 블록 드래그 및 회전 시 효율적인 그림자 및 프리뷰 처리

5. **반응형 디자인**
   - 다양한 화면 크기 지원 (모바일, 태블릿, 데스크톱)
   - 가로/세로 모드 자동 조정
   - 접근성 기능 내장 (고대비 모드, 폰트 크기 조절)

### 데이터 흐름
1. 사용자 입력 -> 2. 상태 업데이트 -> 3. 게임 로직 처리 -> 4. UI 업데이트

#### 상세 데이터 흐름
1. **블록 선택 및 회전 흐름**:
   - 사용자가 선택 가능한 블록 영역에서 블록 선택
   - 터치/클릭으로 선택된 블록 회전
   - 회전 상태 변경 이벤트 발생 및 블록 모델 업데이트
   - 회전된 블록 UI 업데이트 및 회전 애니메이션 실행
   - 회전 상태에 따른 배치 가능 영역 실시간 업데이트

2. **블록 배치 흐름**:
   - 회전된 상태의 블록을 드래그하여 그리드로 이동
   - 블록의 위치가 유효한지 실시간 검증
   - 유효한 위치에서 드롭 시 그리드에 블록 배치
   - 미리보기의 첫 번째 블록이 선택 가능 영역으로 이동
   - 새로운 블록을 미리보기 영역에 생성
   - 블록 생성 시 크기별 확률 적용 (1칸: 5%, 2칸: 15%, 3칸: 40%, 4칸: 40%)

3. **단어 완성 흐름**:
   - 블록 배치 후 가로/세로 방향 단어 자동 검사
   - 단어 데이터베이스와 매칭하여 유효성 확인
   - 유효한 단어 발견 시 시각/청각 피드백 제공
   - 해당 단어 블록 제거 및 점수 계산
   - 완성된 단어 목록에 추가

## 성능 최적화 전략
- 렌더링 최적화를 위한 Canvas 직접 조작
- 대규모 단어 DB의 인덱싱 및 샤딩 전략
- 메모리 관리를 위한 리소스 캐싱 및 해제
- 애니메이션 최적화를 위한 프레임 제한
- 회전된 블록 형태의 캐싱을 통한 연산 최소화
- 미리보기 블록의 효율적인 메모리 관리
- 백그라운드 작업자를 활용한 단어 검색 병렬화
- 4칸 블록 회전 및 배치 검증 최적화

## 테스트 전략
- 단위 테스트: 게임 로직, 블록 회전 시스템 및 단어 검증 시스템
- 위젯 테스트: UI 컴포넌트, 블록 회전 및 미리보기 위젯
- 통합 테스트: 전체 게임 플로우
- 성능 테스트: 대규모 단어 데이터베이스 로딩 및 검색 성능
- 사용자 경험 테스트: 드래그 앤 드롭 및 블록 회전 상호작용의 자연스러움
- 블록 등장 확률 테스트: 설정된 블록 크기별 등장 확률 검증

## 확장성 고려사항
- 플러그인 아키텍처로 새로운 게임 모드 추가 용이
- 다양한 블록 모양 및 회전 패턴 확장 가능한 구조
- 다양한 언어 지원을 위한 국제화 설계
- 외부 API 연동을 위한 인터페이스 설계
- 멀티플레이어 기능을 위한 확장 가능 아키텍처 